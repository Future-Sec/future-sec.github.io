<!DOCTYPE html>
<!--[if IE 8]> <html lang="en" class="ie8 no-js"> <![endif]-->
<!--[if IE 9]> <html lang="en" class="ie9 no-js"> <![endif]-->
<!--[if !IE]><!-->
<html lang="en">
<!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <title>你在互联网上的数据还在裸奔吗？ | 伏宸安全实验室-Future-Sec Information Security Lab</title>

  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <meta name="description" content="这是今年三月份有关移动市场的统计数据,移动app的数量已经突破10亿。移动安全也成为了一个全民关注的问题。从最初的app只针对功能实现，爆出来了一系列的高危漏洞之后，应运而生了包括移动app检测、app加固保护等工作来保护开发者以及使用者权益。同时，http的明文数据传输问题也得到了有效解决。我们本篇文章的讨论内容还是从数据传输过程中所引发的一系列安全问题。  数据裸奔时代使用http协议的数据传">
<meta name="keywords" content="ssl,https">
<meta property="og:type" content="article">
<meta property="og:title" content="你在互联网上的数据还在裸奔吗？">
<meta property="og:url" content="http://www.future-sec.com/android-ssl-security.html">
<meta property="og:site_name" content="伏宸安全实验室-Future-Sec Information Security Lab">
<meta property="og:description" content="这是今年三月份有关移动市场的统计数据,移动app的数量已经突破10亿。移动安全也成为了一个全民关注的问题。从最初的app只针对功能实现，爆出来了一系列的高危漏洞之后，应运而生了包括移动app检测、app加固保护等工作来保护开发者以及使用者权益。同时，http的明文数据传输问题也得到了有效解决。我们本篇文章的讨论内容还是从数据传输过程中所引发的一系列安全问题。  数据裸奔时代使用http协议的数据传">
<meta property="og:image" content="http://ozuqqvmm5.bkt.clouddn.com/20170418102254459.jpg">
<meta property="og:image" content="http://ozuqqvmm5.bkt.clouddn.com/httpa.png">
<meta property="og:image" content="http://ozuqqvmm5.bkt.clouddn.com/httpb.png">
<meta property="og:image" content="http://ozuqqvmm5.bkt.clouddn.com/https_post.png">
<meta property="og:image" content="http://ozuqqvmm5.bkt.clouddn.com/https.png">
<meta property="og:image" content="http://ozuqqvmm5.bkt.clouddn.com/setcer.png">
<meta property="og:image" content="http://ozuqqvmm5.bkt.clouddn.com/getcer.png">
<meta property="og:image" content="http://ozuqqvmm5.bkt.clouddn.com/iscer.png">
<meta property="og:image" content="http://ozuqqvmm5.bkt.clouddn.com/desDecode.png">
<meta property="og:image" content="http://ozuqqvmm5.bkt.clouddn.com/decode2.png">
<meta property="og:image" content="http://ozuqqvmm5.bkt.clouddn.com/decodeiv.png">
<meta property="og:image" content="http://ozuqqvmm5.bkt.clouddn.com/wrong.png">
<meta property="og:image" content="http://ozuqqvmm5.bkt.clouddn.com/wrong2.png">
<meta property="og:image" content="http://ozuqqvmm5.bkt.clouddn.com/jce.jpg">
<meta property="og:updated_time" content="2017-12-21T07:35:04.370Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="你在互联网上的数据还在裸奔吗？">
<meta name="twitter:description" content="这是今年三月份有关移动市场的统计数据,移动app的数量已经突破10亿。移动安全也成为了一个全民关注的问题。从最初的app只针对功能实现，爆出来了一系列的高危漏洞之后，应运而生了包括移动app检测、app加固保护等工作来保护开发者以及使用者权益。同时，http的明文数据传输问题也得到了有效解决。我们本篇文章的讨论内容还是从数据传输过程中所引发的一系列安全问题。  数据裸奔时代使用http协议的数据传">
<meta name="twitter:image" content="http://ozuqqvmm5.bkt.clouddn.com/20170418102254459.jpg">
  
    <link rel="alternative" href="/atom.xml" title="伏宸安全实验室-Future-Sec Information Security Lab" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.ico">
  

  

  <!-- Global styles START -->   
  <link rel="stylesheet" href="/metronic/assets/plugins/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="/metronic/assets/plugins/bootstrap/css/bootstrap.min.css">
  <!-- Global styles END --> 
   
  <!-- Page level plugin styles START -->
  <link rel="stylesheet" href="/metronic/assets/pages/css/animate.css">
  <link rel="stylesheet" href="/metronic/assets/plugins/owl.carousel/assets/owl.carousel.css">
  <!-- Page level plugin styles END -->

  <!-- Theme styles START -->
  <link rel="stylesheet" href="/metronic/assets/pages/css/components.css">
  <link rel="stylesheet" href="/metronic/assets/pages/css/slider.css">
  <link rel="stylesheet" href="/metronic/assets/corporate/css/style.css">
  <link rel="stylesheet" href="/metronic/assets/pages/css/portfolio.css">
  <link rel="stylesheet" href="/metronic/assets/corporate/css/style-responsive.css">
  <link rel="stylesheet" href="/metronic/assets/corporate/css/themes/red.css">
  <link rel="stylesheet" href="/css/theme-styles.css">
  <!-- Theme styles END -->
</head>
</html>
<body class="corporate">
  <!-- BEGIN HEADER -->
<div class="header">
  <div class="container">
    <!--<a class="site-logo" href="/" id="logo">伏宸安全实验室-Future-Sec Information Security Lab</a>-->

    <a class="site-logo" href="/">
      <img src="/metronic/assets/corporate/img/logos/logo-corp-red.png" alt="Metronic FrontEnd">
    </a>

    <a href="javascript:void(0);" class="mobi-toggler"><i class="fa fa-bars"></i></a>

    <!-- BEGIN NAVIGATION -->
    <div class="header-navigation pull-right font-transform-inherit">
      <ul>
	
	<li class="">
	  <a href="/index.html">Home</a>
	</li>
	
	<li class="">
	  <a href="/archives/">Blog</a>
	</li>
	
	<li class="">
	  <a href="/vulnerabilities.html">Vulnerabilities</a>
	</li>
	
	<li class="">
	  <a href="/about/">About</a>
	</li>
	
	<!-- BEGIN TOP SEARCH -->
	<li class="menu-search">
	  <span class="sep"></span>
	  <i class="fa fa-search search-btn"></i>
	  <div class="search-box">
	   
	    <form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank" class="search-form">
    <div class="input-group">
		<input placeholder="Search" class="form-control st-default-search-input" name="word" maxlength="20" type="search">
		  <input name="si" value="future-sec.com" type="hidden">
  <input name="tn" value="bds" type="hidden">
  <input name="cl" value="3" type="hidden">
  <input name="ct" value="2097152" type="hidden">
  <input name="s" value="on" type="hidden">
		<span class="input-group-btn">
		  <button class="btn btn-primary" type="submit">Search</button>
		</span>
	      </div>
</form>
	  </div> 
	</li>
	<!-- END TOP SEARCH -->
      </ul>
    </div>
    <!-- END NAVIGATION -->
  </div>
</div>
<!-- Header END -->

  <div class="container">
  <ul class="breadcrumb">
    <li><a href="/">Home</a></li>
    <li><a href="/archives/">Blog</a></li>
    <li class="active">Post</li>
  </ul>
  <section id="main">
    
    <h2 itemprop="name">
      <a class="article-title" href="/android-ssl-security.html">你在互联网上的数据还在裸奔吗？</a>
    </h2>


    <div class="row">
<div class="col-md-9 col-sm-9 blog-posts">
<article id="post-android-ssl-security" class="article article-type-post blog-item" itemscope="" itemprop="blogPost">
  <div class="article-meta">
  </div>
  <div class="article-inner">
    
    
    <header class="article-header">
      <ul class="blog-info">
	<li><i class="fa fa-user"></i> Crystal</li>
	<li><i class="fa fa-calendar"></i>
	  <time datetime="2017-12-04T16:00:00.000Z" itemprop="datePublished">2017/12/05</time>

	</li>
	<li class="hidden-xs"><i class="fa fa-comments"></i>
	  <a href="http://www.future-sec.com/android-ssl-security.html#disqus_thread" class="article-comment-link">Comments</a>
	</li>
	<li class="hidden-xs"><i class="fa fa-tags"></i> 
	  
  
    <a href="/tags/ssl/" title="ssl">ssl</a>,
  
    <a href="/tags/https/" title="https">https</a>
  


	</li>
      </ul>
      
  <div class="article-category">
    
    Category: 
    
    <a class="article-category-link" href="/categories/移动安全/">移动安全</a>
  </div>
  <br>


    </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      <!-- Table of Contents -->

  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#数据裸奔时代"><span class="toc-number">1.</span> <span class="toc-text">数据裸奔时代</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用http协议的数据传输方式"><span class="toc-number">1.1.</span> <span class="toc-text">使用http协议的数据传输方式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#你所使用的加密数据传输真的有保证你的数据不被窃取吗？"><span class="toc-number">2.</span> <span class="toc-text">你所使用的加密数据传输真的有保证你的数据不被窃取吗？</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#https加密传输"><span class="toc-number">2.1.</span> <span class="toc-text">https加密传输</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTPs单向认证机制"><span class="toc-number">2.2.</span> <span class="toc-text">HTTPs单向认证机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#单向认证过程："><span class="toc-number">2.3.</span> <span class="toc-text">单向认证过程：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Https双向认证机制"><span class="toc-number">2.4.</span> <span class="toc-text">Https双向认证机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#双向认证过程："><span class="toc-number">2.5.</span> <span class="toc-text">双向认证过程：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#我们身边的app中所使用的加密传输是怎样的呢？"><span class="toc-number">3.</span> <span class="toc-text">我们身边的app中所使用的加密传输是怎样的呢？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安全隐患"><span class="toc-number">4.</span> <span class="toc-text">安全隐患</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#扩展-Java-Security安全体系知识延伸"><span class="toc-number">5.</span> <span class="toc-text">扩展 Java Security安全体系知识延伸</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Java-Security-背景知识"><span class="toc-number">5.1.</span> <span class="toc-text">Java Security 背景知识</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JCE的介绍"><span class="toc-number">5.2.</span> <span class="toc-text">JCE的介绍</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#issue"><span class="toc-number">6.</span> <span class="toc-text">issue</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#参考"><span class="toc-number">7.</span> <span class="toc-text">参考</span></a></li></ol>
  </div>

        <p>这是今年三月份有关移动市场的统计数据,移动app的数量已经突破10亿。移动安全也成为了一个全民关注的问题。从最初的app只针对功能实现，爆出来了一系列的高危漏洞之后，应运而生了包括移动app检测、app加固保护等工作来保护开发者以及使用者权益。同时，http的明文数据传输问题也得到了有效解决。我们本篇文章的讨论内容还是从数据传输过程中所引发的一系列安全问题。 <img src="http://ozuqqvmm5.bkt.clouddn.com/20170418102254459.jpg" alt="img"></p>
<h2 id="数据裸奔时代"><a href="#数据裸奔时代" class="headerlink" title="数据裸奔时代"></a>数据裸奔时代</h2><h3 id="使用http协议的数据传输方式"><a href="#使用http协议的数据传输方式" class="headerlink" title="使用http协议的数据传输方式"></a>使用http协议的数据传输方式</h3><p>HyperText Transfer Protocol，超文本传输协议，是互联网上使用最广泛的一种协议，所有WWW文件必须遵循的标准。HTTP协议传输的数据都是未加密的，也就是明文的，因此使用HTTP协议传输隐私信息非常不安全。<br>使用TCP端口为：80<br>最初的移动app开发过程中，使用的大部分http协议来进行客户端跟服务端的通信。这个过程中传输的信息都是明文，继而引发了一系列的信息泄露等漏洞.<br><img src="http://ozuqqvmm5.bkt.clouddn.com/httpa.png" alt="img"><br>wireshark简单捕获就能看到明文隐私数据<br><img src="http://ozuqqvmm5.bkt.clouddn.com/httpb.png" alt="img"><br>当然上述极为不安全的数据传输，在2015年被大量爆出来之后，立即引起了app的开发人员以及使用着的重视。后续的数据传输使用了相对安全的基于SSL/TLS加密的安全的超文本传输协议https。</p>
<h2 id="你所使用的加密数据传输真的有保证你的数据不被窃取吗？"><a href="#你所使用的加密数据传输真的有保证你的数据不被窃取吗？" class="headerlink" title="你所使用的加密数据传输真的有保证你的数据不被窃取吗？"></a>你所使用的加密数据传输真的有保证你的数据不被窃取吗？</h2><h3 id="https加密传输"><a href="#https加密传输" class="headerlink" title="https加密传输"></a>https加密传输</h3><p>Hyper Text Transfer Protocol over Secure Socket Layer，安全的超文本传输协议，网景公式设计了SSL(Secure Sockets Layer)协议用于对Http协议传输的数据进行加密，保证会话过程中的安全性。<br>使用TCP端口默认为443<br>SSL协议即用到了对称加密也用到了非对称加密(公钥加密)，在建立传输链路时，SSL首先对对称加密的密钥使用公钥进行非对称加密，链路建立好之后，SSL对传输内容使用对称加密。<br>对称加密</p>
<p>速度高，可加密内容较大，用来加密会话过程中的消息<br>公钥加密 加密速度较慢，但能提供更好的身份认证技术，用来加密对称加密的密钥</p>
<h3 id="HTTPs单向认证机制"><a href="#HTTPs单向认证机制" class="headerlink" title="HTTPs单向认证机制"></a>HTTPs单向认证机制</h3><p>单向认证主要是客户端保存有服务端的公钥证书，自己本身是没有私钥证书的。<br>1、给服务器生成密钥方式：<br>keytool -genkeypair -alias skxy -keyalg RSA -validity 3650 -keypass 123456 -storepass 123456 -keystore skxy.keystore<br>2、给Tomcat服务器配置Https<br>tomcat/config/server.xml修改connector配置<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;Connector port=<span class="string">"8443"</span> protocol=<span class="string">"org.apache.coyote.http11.Http11Protocol"</span></div><div class="line">        maxThreads=<span class="string">"150"</span> SSLEnabled=<span class="string">"true"</span> scheme=<span class="string">"https"</span> secure=<span class="string">"true"</span></div><div class="line">        clientAuth=<span class="string">"false"</span> sslProtocol=<span class="string">"TLS"</span></div><div class="line">        keystoreFile=<span class="string">"conf/skxy.keystore"</span></div><div class="line">        keystorePass=<span class="string">"123456"</span>/&gt;</div></pre></td></tr></table></figure></p>
<p>3、导出证书<br>keytool -export -alias skxy -file skxy.cer -keystore skxy.keystore -storepass 123456<br>4、将证书放在android客户端，能够读取的地方比如assert目录 5.代码中执行网络请求，获取证书，读取https网站的数据。<br>客户端单向认证代码实现部分<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">String path = <span class="string">"https://10.0.3.2:8443/Test/Hlloer"</span>;</div><div class="line">?</div><div class="line">   <span class="keyword">try</span> &#123;  </div><div class="line">       <span class="comment">//获取证书  </span></div><div class="line">       InputStream stream = getAssets().open(<span class="string">"skxy.cer"</span>);  </div><div class="line">       SSLContext tls = SSLContext.getInstance(<span class="string">"TLS"</span>);  </div><div class="line">       <span class="comment">//使用默认证书  </span></div><div class="line">       KeyStore keystore = KeyStore.getInstance(KeyStore.getDefaultType());  </div><div class="line">       <span class="comment">//去掉系统默认证书  </span></div><div class="line">       keystore.load(<span class="keyword">null</span>);  </div><div class="line">       Certificate certificate =            CertificateFactory.getInstance(<span class="string">"X.509"</span>).generateCertificate(stream);  </div><div class="line">       <span class="comment">//设置自己的证书  </span></div><div class="line">       keystore.setCertificateEntry(<span class="string">"skxy"</span>, certificate);  </div><div class="line">       <span class="comment">//通过信任管理器获取一个默认的算法  </span></div><div class="line">       String algorithm = TrustManagerFactory.getDefaultAlgorithm();  </div><div class="line">       <span class="comment">//算法工厂创建  </span></div><div class="line">       TrustManagerFactory instance = TrustManagerFactory.getInstance(algorithm);  </div><div class="line">       instance.init(keystore);  </div><div class="line">       tls.init(<span class="keyword">null</span>, instance.getTrustManagers(), <span class="keyword">null</span>);  </div><div class="line">       SSLSocketFactory socketFactory = tls.getSocketFactory();  </div><div class="line">       HttpsURLConnection.setDefaultSSLSocketFactory(socketFactory);  </div><div class="line">       URL url = <span class="keyword">new</span> URL(path);  </div><div class="line">       HttpsURLConnection conn = (HttpsURLConnection) url.openConnection();  </div><div class="line">       <span class="comment">//设置ip授权认证：如果已经安装该证书，可以不设置，否则需要设置  </span></div><div class="line">       conn.setHostnameVerifier(<span class="keyword">new</span> HostnameVerifier() &#123;  </div><div class="line">           @Override  </div><div class="line">           <span class="keyword">public</span> boolean verify(String hostname, SSLSession session) &#123;  </div><div class="line">               <span class="keyword">return</span> <span class="keyword">true</span>;  </div><div class="line"></div><div class="line">           &#125;  </div><div class="line"></div><div class="line">       &#125;);  </div><div class="line">       InputStream inputStream = conn.getInputStream();  </div><div class="line">       String result = getString(inputStream);  </div><div class="line">       stream.close();</div></pre></td></tr></table></figure></p>
<h3 id="单向认证过程："><a href="#单向认证过程：" class="headerlink" title="单向认证过程："></a>单向认证过程：</h3><p>(1) 客户端向服务端发送SSL协议版本号、加密算法种类、随机数等信息。<br>(2) 服务端给客户端返回SSL协议版本号、加密算法种类、随机数等信息，同时也返回服务器端的证书，即公钥证书<br>(3) 客户端使用服务端返回的信息验证服务器的合法性，包括：<br> 1.证书是否过期<br> 2.发型服务器证书的CA是否可靠<br> 3.返回的公钥是否能正确解开返回证书中的数字签名<br> 4.服务器证书上的域名是否和服务器的实际域名相匹配<br> 5.验证通过后，将继续进行通信，否则，终止通信<br>(4) 客户端向服务端发送自己所能支持的对称加密方案，供服务器端进行选择<br>(5) 服务器端在客户端提供的加密方案中选择加密程度最高的加密方式。<br>(6) 服务器将选择好的加密方案通过明文方式返回给客户端<br>(7) 客户端接收到服务端返回的加密方式后，使用该加密方式生成产生随机码，用作通信过程中对称加密的密钥，使用服务端返回的公钥进行加密，将加密后的随机码发送至服务器<br>(8) 服务器收到客户端返回的加密信息后，使用自己的私钥进行解密，获取对称加密密钥。<br>在接下来的会话中，服务器和客户端将会使用该密码进行对称加密，保证通信过程中信息的安全。</p>
<h3 id="Https双向认证机制"><a href="#Https双向认证机制" class="headerlink" title="Https双向认证机制"></a>Https双向认证机制</h3><p>首先对于双向证书验证，也就是说，客户端有自己的密钥，并持有服务端的证书，服务端给客户端发送数据时，需要将服务端的证书发给客户端验证，验证通过才运行发送数据，同样，客户端请求服务器数据时，也需要将自己的证书发给服务端验证，通过才允许执行请求。<br>客户端双向认证代码实现部分<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySSLSocketFactory</span> </span>&#123;</div><div class="line">?</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_STORE_TYPE_BKS = <span class="string">"bks"</span>;<span class="comment">//证书类型</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_STORE_TYPE_P12 = <span class="string">"PKCS12"</span>;<span class="comment">//证书类型</span></div><div class="line">?</div><div class="line">?</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_STORE_PASSWORD = <span class="string">"****"</span>;<span class="comment">//证书密码（应该是客户端证书密码）</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_STORE_TRUST_PASSWORD = <span class="string">"***"</span>;<span class="comment">//授信证书密码（应该是服务端证书密码）</span></div><div class="line">?</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SSLSocketFactory getSocketFactory(Context context) &#123;</div><div class="line">?</div><div class="line">?</div><div class="line">        InputStream trust_input = context.getResources().openRawResource(R.raw.trust);<span class="comment">//服务器授信证书</span></div><div class="line">        InputStream client_input = context.getResources().openRawResource(R.raw.client);<span class="comment">//客户端证书</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">                    SSLContext sslContext = SSLContext.getInstance(<span class="string">"TLS"</span>); </div><div class="line">                    KeyStore trustStore = KeyStore.getInstance(KeyStore.getDefaultType());</div><div class="line">                    trustStore.load(trust_input, KEY_STORE_TRUST_PASSWORD.toCharArray()); </div><div class="line">                    KeyStore keyStore = KeyStore.getInstance(KEY_STORE_TYPE_P12);  </div><div class="line">                    keyStore.load(client_input, KEY_STORE_PASSWORD.toCharArray());</div><div class="line">                    TrustManagerFactory trustManagerFactory = TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm());</div><div class="line">                    trustManagerFactory.init(trustStore);</div><div class="line">                    KeyManagerFactory keyManagerFactory = KeyManagerFactory.getInstance(KeyManagerFactory.getDefaultAlgorithm());</div><div class="line">                   keyManagerFactory.init(keyStore, KEY_STORE_PASSWORD.toCharArray());</div><div class="line">                   sslContext.init(keyManagerFactory.getKeyManagers(), trustManagerFactory.getTrustManagers(), <span class="keyword">new</span> SecureRandom());</div><div class="line">                   SSLSocketFactory factory = sslContext.getSocketFactory();</div><div class="line">                   <span class="keyword">return</span> factory;</div><div class="line">               &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> e) &#123;</div><div class="line">                           e.printStackTrace(); </div><div class="line">                          <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">               &#125; <span class="keyword">finally</span> &#123; </div><div class="line">                          <span class="keyword">try</span> &#123;</div><div class="line">                                trust_input.close(); </div><div class="line">                               client_input.close();</div><div class="line">                          &#125; <span class="keyword">catch</span> (IOException e) &#123; </div><div class="line">                               e.printStackTrace();  </div><div class="line">                         &#125; </div><div class="line">               &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="双向认证过程："><a href="#双向认证过程：" class="headerlink" title="双向认证过程："></a>双向认证过程：</h3><p>(1) 客户端向服务端发送SSL协议版本号、加密算法种类、随机数等信息。<br>(2) 服务端给客户端返回SSL协议版本号、加密算法种类、随机数等信息，同时也返回服务器端的证书，即公钥证书<br> 客户端使用服务端返回的信息验证服务器的合法性，包括：<br> 1.证书是否过期<br> 2.发型服务器证书的CA是否可靠<br> 3.返回的公钥是否能正确解开返回证书中的数字签名<br> 4.服务器证书上的域名是否和服务器的实际域名相匹配<br>(3) 验证通过后，将继续进行通信，否则，终止通信<br>(4) 服务端要求客户端发送客户端的证书，客户端会将自己的证书发送至服务端<br>(5) 验证客户端的证书，通过验证后，会获得客户端的公钥<br>(6) 客户端向服务端发送自己所能支持的对称加密方案，供服务器端进行选择<br>(7) 服务器端在客户端提供的加密方案中选择加密程度最高的加密方式<br>(8) 将加密方案通过使用之前获取到的公钥进行加密，返回给客户端<br>(9) 客户端收到服务端返回的加密方案密文后，使用自己的私钥进行解密，获取具体加密方式，而后，产生该加密方式的随机码，用作加密过程中的密钥，使用之前从服务端证书中获取到的公钥进行加密后，发送给服务端<br>(10) 服务端收到客户端发送的消息后，使用自己的私钥进行解密，获取对称加密的密钥，在接下来的会话中，服务器和客户端将会使用该密码进行对称加密，保证通信过程中信息的安全。</p>
<h2 id="我们身边的app中所使用的加密传输是怎样的呢？"><a href="#我们身边的app中所使用的加密传输是怎样的呢？" class="headerlink" title="我们身边的app中所使用的加密传输是怎样的呢？"></a>我们身边的app中所使用的加密传输是怎样的呢？</h2><p>某宝（金融类app）的数据加密分析（https单向认证） 为了更加清晰的了解https在实际项目中的应用，特意花了点时间分析了一个app的加密认证过程。app虽然加了部分混淆，但并没有加固，所以也不难分析。<br>（1）整个发送https post请求过程.ip以及域名都是固定的，证书也写死在app里。<br><img src="http://ozuqqvmm5.bkt.clouddn.com/https_post.png" alt="img"><br>（2）https认证过程<br>判断代理服务器以及证书校验<br><img src="http://ozuqqvmm5.bkt.clouddn.com/https.png" alt="img"><br>证书校验过程<br>在获取证书的过程中，仅仅读取了证书的信息，并没有实现校验证书是否安全可靠的代码。这里就留下了安全隐患。使用第三方证书一样可以截获数据。<br><img src="http://ozuqqvmm5.bkt.clouddn.com/setcer.png" alt="img"><br><img src="http://ozuqqvmm5.bkt.clouddn.com/getcer.png" alt="img"><br><img src="http://ozuqqvmm5.bkt.clouddn.com/iscer.png" alt="img"><br>数据解密过程<br>在数据解密过程也不够严谨，密钥和向量通过简单逆向分析就能获得。<br><img src="http://ozuqqvmm5.bkt.clouddn.com/desDecode.png" alt="img"><br>解密key的获取方式：数据包名的md5<br><img src="http://ozuqqvmm5.bkt.clouddn.com/decode2.png" alt="img"><br>解密向量<br><img src="http://ozuqqvmm5.bkt.clouddn.com/decodeiv.png" alt="img"><br>通过这个简单分析，你还敢说你的数据是安全传输的吗？</p>
<h2 id="安全隐患"><a href="#安全隐患" class="headerlink" title="安全隐患"></a>安全隐患</h2><p>因为开发方便而信任所有证书<br><img src="http://ozuqqvmm5.bkt.clouddn.com/wrong.png" alt="img"><br>重写了校验机制，但并没有做任何检验SSL证书有效性。<br><img src="http://ozuqqvmm5.bkt.clouddn.com/wrong2.png" alt="img"></p>
<h2 id="扩展-Java-Security安全体系知识延伸"><a href="#扩展-Java-Security安全体系知识延伸" class="headerlink" title="扩展 Java Security安全体系知识延伸"></a>扩展 Java Security安全体系知识延伸</h2><h3 id="Java-Security-背景知识"><a href="#Java-Security-背景知识" class="headerlink" title="Java Security 背景知识"></a>Java Security 背景知识</h3><p>Java Security其实是Java平台中一个比较独立的模块。除了软件实现上内容外，它实际上对应了一系列的规范。从Java2开始，Java Security包含主要三个重要的规范：</p>
<p>JavaCryptography Extension（简写为JCE），JCE所包含的内容有加解密，密钥交换，消息摘要（Message Digest，比如MD5等），密钥管理等。本文所涉及的大部分内容都属于JCE的范畴。<br>JavaSecure Socket Extension（简写为JSSE），JSSE所包含的内容就是Java层的SSL/TLS。简单点说，使用JSSE就可以创建SSL/TLS socket了。<br>JavaAuthentication and Authorization Service（简写为JAAS），JSSA和认证/授权有关。这部分内容在客户端接触得会比较少一点，所以本文不拟讨论它。<br>在上述三个子模块或规范中，JCE是JavaSecurity的大头，其他两个子模块JSSE和JAAS都依赖于它，比如SSL/TLS在工作过程中需要使用密钥对数据进行加解密，那么密钥的创建和使用就依靠JCE子模块了。 另外，既然和安全相关，那么对安全敏感的相关部门或政府肯定会有所干涉。Java是在美国被发明的，所以美国政府对于Java Security方面的出口（比如哪些模块，哪些功能能给其他国家使用）有相关的限制。例如，不允许出口的JCE（从软件实现上看，可能就是从Java官网上下载到的几个Jar包文件）支持一些高级的加解密功能（比如在密钥长度等方面有所限制）。</p>
<h3 id="JCE的介绍"><a href="#JCE的介绍" class="headerlink" title="JCE的介绍"></a>JCE的介绍</h3><p>JCE最初是作为JCA的扩展包开发的，旨在提供受美国出口控制条例管制的加密服务API和实现。JCE提供一个提供者实现和一组相关的API和包，以支持加密和解密，密钥的生成和协商以及消息验证算法，其中对加密和解密的支持包括对称加密、非对称加密、块加密和流加密。JCE还支持安全流和封装流对象。<br>JCE的架构模型如下图所示：<br><img src="http://ozuqqvmm5.bkt.clouddn.com/jce.jpg" alt="img"></p>
<h2 id="issue"><a href="#issue" class="headerlink" title="issue"></a>issue</h2><p>1.不要忽略证书校验</p>
<p>2.保护好自己的密钥</p>
<p>3.尽量使用规范的https协议</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>1.<a href="http://blog.csdn.net/xdd19910505/article/details/51926540" rel="external nofollow noopener noreferrer" target="_blank">http://blog.csdn.net/xdd19910505/article/details/51926540</a></p>
<p>2.<a href="https://www.cnblogs.com/xiekeli/p/5607107.html" rel="external nofollow noopener noreferrer" target="_blank">https://www.cnblogs.com/xiekeli/p/5607107.html</a></p>
<p>3.<a href="http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2014/0607/1621.html" rel="external nofollow noopener noreferrer" target="_blank">http://www.jcodecraeer.com/a/anzhuokaifa/androidkaifa/2014/0607/1621.html</a></p>
<p>4.<a href="https://www.waitalone.cn/bank-ssl-cap.html" rel="external nofollow noopener noreferrer" target="_blank">https://www.waitalone.cn/bank-ssl-cap.html</a></p>

      
    </div>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/iot-security-hardware-debuging.html" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          物联网硬件安全分析基础-串口调试
        
      </div>
    </a>
  
  
    <a href="/how-to-crack-a-ble-lock.html" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">如何破解一个蓝牙锁</div>
    </a>
  
</nav>

  
  <br>
</article>




</div>
<div class="col-md-3 col-sm-3 blog-sidebar">
  <!-- CATEGORIES START -->
<h2 class="no-top-space">Categories</h2>

<div class="widget-wrap">
  <div class="widget">
    <ul class="nav sidebar-categories margin-bottom-40">
      
	<li>
	  <a href="/categories/移动安全/">移动安全 (2)</a>
	</li>
      
	<li>
	  <a href="/categories/硬件安全/">硬件安全 (7)</a>
	</li>
      
	<li>
	  <a href="/categories/web安全/">web安全 (5)</a>
	</li>
      
	<li>
	  <a href="/categories/系统安全/">系统安全 (1)</a>
	</li>
      
    </ul>
  </div>
</div>


<!-- CATEGORIES END -->

<!-- BEGIN BLOG TAGS -->
<div class="blog-tags margin-bottom-20">
  <h2>Tags</h2>
  
  <div class="widget-wrap">
    <div class="widget">
      
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/BROADCOM-WI-FI/"><i class="fa fa-tags"></i>BROADCOM WI-FI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MITMf/"><i class="fa fa-tags"></i>MITMf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Poc/"><i class="fa fa-tags"></i>Poc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tomcat/"><i class="fa fa-tags"></i>Tomcat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UART串口调试/"><i class="fa fa-tags"></i>UART串口调试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/app签名/"><i class="fa fa-tags"></i>app签名</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/https/"><i class="fa fa-tags"></i>https</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/"><i class="fa fa-tags"></i>python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ssl/"><i class="fa fa-tags"></i>ssl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web安全/"><i class="fa fa-tags"></i>web安全</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/内网渗透/"><i class="fa fa-tags"></i>内网渗透</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/指纹识别/"><i class="fa fa-tags"></i>指纹识别</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/智能锁/"><i class="fa fa-tags"></i>智能锁</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/条形码/"><i class="fa fa-tags"></i>条形码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/硬件分析/"><i class="fa fa-tags"></i>硬件分析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/硬件安全/"><i class="fa fa-tags"></i>硬件安全</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/移动安全/"><i class="fa fa-tags"></i>移动安全</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/自动化检测/"><i class="fa fa-tags"></i>自动化检测</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/蓝牙攻击/"><i class="fa fa-tags"></i>蓝牙攻击</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/远程代码执行/"><i class="fa fa-tags"></i>远程代码执行</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/验证码/"><i class="fa fa-tags"></i>验证码</a></li></ul>
    </div>
  </div>


</div>
<!-- END BLOG TAGS -->


<!-- BEGIN FEATURED POSTS -->                            
<h2>Featured Posts</h2>
<div class="recent-news margin-bottom-10">
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
    
  
</div>
<!-- END FEATURED POSTS -->                            

</div>
</div>

  </section>
</div>

    <!-- BEGIN PRE-FOOTER -->
    <div class="pre-footer">
      <div class="container">
        <div class="row">
          <!-- BEGIN BOTTOM ABOUT BLOCK -->
          <div class="col-md-4 col-sm-6 pre-footer-col">
            <h2>About Us</h2>
            <p>伏宸安全实验室<br><br> 伏宸安全实验室是广东安创信息科技开发有限公司旗下的以网络安全研究为核心的专业实验室，主攻前沿安全技术，包括：渗透测试、黑产对抗、威胁情报、智能硬件与无线电安全等。</p>
          </div>
          <!-- END BOTTOM ABOUT BLOCK -->

          <!-- BEGIN BOTTOM CONTACTS -->
          <div class="col-md-4 col-sm-6 pre-footer-col">
            <h2>Contact</h2>
            <address class="margin-bottom-40">
              广州市越秀区寺右新马路108号丰伟大厦15B、C单元<br>
              BC 15/F Fengwei Buiding NO.108 Siyouxinma Road<br>
              Guangzhou,China Code:510600<br>
              Phone: 020-87392713<br>
              Email: <a href="mailto:admin@future-sec.com" rel="external nofollow noopener noreferrer" target="_blank">admin@future-sec.com</a><br>
            </address>
          </div>
          <!-- END BOTTOM CONTACTS -->

	
        </div>
      </div>
    </div>
    <!-- END PRE-FOOTER -->

    <!-- BEGIN FOOTER -->
    <div class="footer">
      <div class="container">
        <div class="row">
          <!-- BEGIN COPYRIGHT -->
          <div class="col-md-6 col-sm-6 padding-top-10">
                  &copy; 2017 伏宸安全实验室-Future-Sec Information Security Lab<br>
 <a href="javascript:;">Future-sec</a> | <a href="javascript:;">广东安创信息科技开发有限公司</a>
          </div>
          <!-- END COPYRIGHT -->
	  <!-- BEGIN SOCIAL -->
<div class="col-md-6 col-sm-6">
  <ul class="social-footer list-unstyled list-inline pull-right">
    
      <li><a href="https://github.com/Future-Sec/" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-github"></i></a></li>
    
      <li><a href="https://weibo.com/futuresec" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-weibo"></i></a></li>
    
      <li><a href="https://mp.weixin.qq.com/s/QuDKBrMist8GL16EEO-u4Q" rel="external nofollow noopener noreferrer" target="_blank"><i class="fa fa-weixin"></i></a></li>
    
      <li><a href="/atom.xml"><i class="fa fa-rss"></i></a></li>
    
  </ul>  
</div>
<!-- END SOCIAL -->

        </div>
      </div>
    </div>
    <!-- END FOOTER -->

  <!-- BEGIN CORE PLUGINS (REQUIRED FOR ALL PAGES) -->
<!--[if lt IE 9]>
<script src="/metronic/assets/plugins/respond.min.js"></script>
<![endif]--> 
<script src="/metronic/assets/plugins/jquery.min.js"></script>
<script src="/metronic/assets/plugins/jquery-migrate.min.js"></script>
<script src="/metronic/assets/plugins/bootstrap/js/bootstrap.min.js"></script>
<script src="/metronic/assets/corporate/scripts/back-to-top.js"></script>
<script src="/metronic/assets/plugins/owl.carousel/owl.carousel.min.js"></script>
<script src="/metronic/assets/corporate/scripts/layout.js"></script>
<script src="/js/wow.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script type="text/javascript">
    jQuery(document).ready(function() {
        Layout.init();    
        Layout.initOWL();
        Layout.initFixHeaderWithPreHeader(); /* Switch On Header Fixing (only if you have pre-header) */
        Layout.initNavScrolling(); 
	new WOW().init();
    });
</script>
 <script>
        // 给图片添加链接
        $(document).ready(function() {
            $("p img").each(function() {
                var strA = "<a class='fancybox' href='" + this.src + "'></a>";
                $(this).wrapAll(strA);
            });
        });
    
        // fancybox
        $(".fancybox").fancybox({
                                  openEffect    : 'elastic',
                                  closeEffect   : 'elastic',
                              });
    </script>
    <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?9e36ea61528e32ab9a0bc86aa61db5f7";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>
<!-- END CORE PLUGINS -->

<!-- BEGIN PAGE-SPECIFIC PLUGINS --> 







<!-- END PAGE-SPECIFIC PLUGINS --> 

<!-- BEGIN INTEGRATIONS -->





<!-- END INTEGRATIONS -->

</body>

